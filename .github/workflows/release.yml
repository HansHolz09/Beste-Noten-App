name: Release Compose Multiplatform & Deploy WASM

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    uses: ./.github/workflows/buildCompose.yml
    with:
      upload_wasm_as_pages_artifact: true
    secrets: inherit

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Read version from libs.versions.toml
        id: version
        run: |
          set -e
          FILE="gradle/libs.versions.toml"
          [ -f "$FILE" ] || FILE="libs.versions.toml"
          APP_VERSION=$(awk -F '"' '/appVersion/ {print $2; exit}' "$FILE")
          [ -n "$APP_VERSION" ] || { echo "appVersion not found"; exit 1; }
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT

      - name: Create tag if missing
        run: |
          set -e
          git fetch --tags
          if git ls-remote --exit-code --tags origin "refs/tags/v${APP_VERSION}" >/dev/null 2>&1; then
            echo "Tag exists."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "v${APP_VERSION}"
            git push origin "v${APP_VERSION}"
          fi

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets
          merge-multiple: true

      - name: Remove Pages artifact from release assets
        run: |
          set -e
          ls -l release_assets
          rm -f release_assets/artifact.tar

      - name: Rename files
        run: |
          set -e
          REPO="${GITHUB_REPOSITORY##*/}"
          cd release_assets
          [ -f android-universal.apk ] && mv android-universal.apk "${REPO}-${APP_VERSION}-android-universal.apk"
          [ -f ios-unsigned.ipa ]     && mv ios-unsigned.ipa     "${REPO}-${APP_VERSION}-ios-unsigned.ipa"
          [ -f windows-x64.exe ]      && mv windows-x64.exe      "${REPO}-${APP_VERSION}-windows-x64.exe"
          [ -f windows-arm64.exe ]    && mv windows-arm64.exe    "${REPO}-${APP_VERSION}-windows-arm64.exe"
          [ -f macos-arm64.dmg ]      && mv macos-arm64.dmg      "${REPO}-${APP_VERSION}-macos-arm64.dmg"
          [ -f linux-x64.deb ]        && mv linux-x64.deb        "${REPO}-${APP_VERSION}-linux-x64.deb"
          [ -f linux-arm64.deb ]      && mv linux-arm64.deb      "${REPO}-${APP_VERSION}-linux-arm64.deb"
          ls -l

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.APP_VERSION }}
          name: ${{ env.APP_VERSION }}
          draft: true
          generate_release_notes: true
          files: release_assets/*

  wasm-pages:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
